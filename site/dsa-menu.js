// DSA Basics Menu Data Structure
const dsaBasicsData = {
  "dataStructures": {
    "title": "Data Structures",
    "items": [
      {
        "name": "Arrays",
        "url": "https://www.technavigator.io/dsa-basics/arrays",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/arrays/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/arrays/basic-operations"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/arrays/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/arrays/practice"}
        ]
      },
      {
        "name": "Linked Lists",
        "url": "https://www.technavigator.io/dsa-basics/linked-lists",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/linked-lists/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/linked-lists/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/linked-lists/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/linked-lists/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/linked-lists/practice"}
        ]
      },
      {
        "name": "Hash Tables",
        "url": "https://www.technavigator.io/dsa-basics/hash-tables",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/hash-tables/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/hash-tables/basic-operations"},
          {"name": "Collision Handling", "url": "https://www.technavigator.io/dsa-basics/hash-tables/collision-handling"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/hash-tables/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/hash-tables/practice"}
        ]
      },
      {
        "name": "Stacks",
        "url": "https://www.technavigator.io/dsa-basics/stacks",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/stacks/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/stacks/basic-operations"},
          {"name": "Applications", "url": "https://www.technavigator.io/dsa-basics/stacks/applications"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/stacks/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/stacks/practice"}
        ]
      },
      {
        "name": "Queues",
        "url": "https://www.technavigator.io/dsa-basics/queues",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/queues/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/queues/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/queues/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/queues/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/queues/practice"}
        ]
      },
      {
        "name": "Trees",
        "url": "https://www.technavigator.io/dsa-basics/trees",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/trees/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/trees/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/trees/types"},
          {
            "name": "Traversal",
            "url": "https://www.technavigator.io/dsa-basics/trees/traversal",
            "subitems": [
              {"name": "Inorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/inorder"},
              {"name": "Preorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/preorder"},
              {"name": "Postorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/postorder"},
              {"name": "Level Order Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/level-order"}
            ]
          },
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/trees/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/trees/practice"}
        ]
      },
      {
        "name": "Heaps",
        "url": "https://www.technavigator.io/dsa-basics/heaps",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/heaps/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/heaps/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/heaps/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/heaps/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/heaps/practice"}
        ]
      },
      {
        "name": "Tries",
        "url": "https://www.technavigator.io/dsa-basics/tries",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/tries/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/tries/basic-operations"},
          {"name": "Applications", "url": "https://www.technavigator.io/dsa-basics/tries/applications"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/tries/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/tries/practice"}
        ]
      },
      {
        "name": "Graphs",
        "url": "https://www.technavigator.io/dsa-basics/graphs",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/graphs/introduction"},
          {"name": "Representations", "url": "https://www.technavigator.io/dsa-basics/graphs/representations"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/graphs/basic-operations"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/graphs/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/graphs/practice"}
        ]
      }
    ]
  },
  "algorithms": {
    "title": "Algorithms",
    "items": [
      {
        "name": "Searching Algorithms",
        "url": "https://www.technavigator.io/dsa-basics/searching-algorithms",
        "subitems": [
          {"name": "Linear Search", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/linear-search"},
          {"name": "Binary Search", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/binary-search"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/practice"}
        ]
      },
      {
        "name": "Sorting Algorithms",
        "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms",
        "subitems": [
          {"name": "Bubble Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/bubble-sort"},
          {"name": "Selection Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/selection-sort"},
          {"name": "Insertion Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/insertion-sort"},
          {"name": "Merge Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/merge-sort"},
          {"name": "Quick Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/quick-sort"},
          {"name": "Heap Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/heap-sort"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/practice"}
        ]
      },
      {
        "name": "Graph Algorithms",
        "url": "https://www.technavigator.io/dsa-basics/graph-algorithms",
        "subitems": [
          {"name": "Depth-First Search (DFS)", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/dfs"},
          {"name": "Breadth-First Search (BFS)", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/bfs"},
          {
            "name": "Shortest Path Algorithms",
            "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path",
            "subitems": [
              {"name": "Dijkstra's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/dijkstra"},
              {"name": "Bellman-Ford Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/bellman-ford"},
              {"name": "Floyd-Warshall Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/floyd-warshall"}
            ]
          },
          {
            "name": "Minimum Spanning Tree",
            "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/minimum-spanning-tree",
            "subitems": [
              {"name": "Kruskal's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/minimum-spanning-tree/kruskal"},
              {"name": "Prim's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/minimum-spanning-tree/prim"}
            ]
          },
          {"name": "Topological Sort", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/topological-sort"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/practice"}
        ]
      },
      {
        "name": "Algorithm Techniques",
        "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques",
        "subitems": [
          {"name": "Two Pointers", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/two-pointers"},
          {"name": "Sliding Window", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/sliding-window"},
          {"name": "Prefix Sum", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/prefix-sum"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/practice"}
        ]
      },
      {
        "name": "Advanced Algorithms",
        "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms",
        "subitems": [
          {"name": "Divide and Conquer", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/divide-and-conquer"},
          {"name": "Greedy Algorithms", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/greedy"},
          {"name": "Backtracking", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/backtracking"},
          {
            "name": "Dynamic Programming",
            "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming",
            "subitems": [
              {"name": "1D Dynamic Programming", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/1d"},
              {"name": "2D Dynamic Programming", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/2d"},
              {"name": "State Compression", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/state-compression"}
            ]
          },
          {"name": "Union Find", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/union-find"},
          {"name": "Monotonic Stack/Queue", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/monotonic-stack-queue"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/practice"}
        ]
      }
    ]
  }
};

// Function to check if current page is a DSA Basics page
function isDsaBasicsPage() {
  const currentURL = window.location.href.toLowerCase();
  return currentURL.includes('dsa-basics') || 
         (currentURL.includes('technavigator.io') && 
          (currentURL.includes('/array') || 
           currentURL.includes('/linked-list') || 
           currentURL.includes('/stack') || 
           currentURL.includes('/queue') || 
           currentURL.includes('/tree') || 
           currentURL.includes('/graph') || 
           currentURL.includes('/algorithm') || 
           currentURL.includes('/search') || 
           currentURL.includes('/sort')));
}

// Create our own sidebar for DSA Basics
function createDsaBasicsSidebar() {
  // Only run on DSA Basics pages
  if (!isDsaBasicsPage()) {
    return;
  }

  // Fix sidebar container to ensure scrollability
  const sidebarContainer = document.querySelector('.sidebar');
  if (sidebarContainer) {
    // Set scrollable styles directly on the container
    sidebarContainer.style.maxHeight = '85vh';
    sidebarContainer.style.overflowY = 'auto';
    sidebarContainer.style.display = 'flex';
    sidebarContainer.style.flexDirection = 'column';
    
    // Also fix any parent element that might be constraining the height
    const sidebarParent = sidebarContainer.parentElement;
    if (sidebarParent) {
      sidebarParent.style.height = 'auto';
      sidebarParent.style.maxHeight = 'none';
      sidebarParent.style.overflow = 'visible';
    }
  }

  // Get the sidebar
  let sidebar = document.querySelector('.sidebar-nav');
  if (!sidebar) {
    console.error("Sidebar not found, creating new one");
    sidebar = document.createElement('ul');
    sidebar.className = 'sidebar-nav';
    if (sidebarContainer) {
      sidebarContainer.innerHTML = ''; // Clear the container
      sidebarContainer.appendChild(sidebar);
    } else {
      console.error("Sidebar container not found");
      return;
    }
  } else {
    // Clear existing sidebar - this is intentional for DSA Basics pages
    sidebar.innerHTML = '';
  }

  // Create main DSA Basics menu item
  const dsaBasicsItem = document.createElement('li');
  dsaBasicsItem.className = 'sidebar-nav-item expanded';
  dsaBasicsItem.innerHTML = `
    <div class="sidebar-nav-link main-category">
      <svg fill='none' height='16' stroke='currentColor' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' viewBox='0 0 24 24' width='16' xmlns='http://www.w3.org/2000/svg'>
        <path d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'/>
        <rect x='9' y='2' width='6' height='4' rx='1'/>
        <path d='M9 12h6'/>
        <path d='M12 9v6'/>
      </svg>
      <span>DSA Basics</span>
    </div>
    <ul class="sidebar-subnav" id="dsa-basics-subnav"></ul>
  `;
  sidebar.appendChild(dsaBasicsItem);

  // Get the subnav container
  const dsaBasicsSubnav = document.getElementById('dsa-basics-subnav');

  // Add CSS styles for nested menus
  addDsaBasicsStyles();

  // Add each category section
  Object.keys(dsaBasicsData).forEach(categoryKey => {
    const category = dsaBasicsData[categoryKey];
    
    // Add category header
    const categoryHeader = document.createElement('li');
    categoryHeader.className = 'sidebar-subnav-item expanded'; // Expanded by default
    categoryHeader.innerHTML = `
      <a href="javascript:void(0)" class="sidebar-subnav-link category-header">
        <span>${category.title}</span>
        <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" 
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
      <ul class="sidebar-nested-nav"></ul>
    `;
    dsaBasicsSubnav.appendChild(categoryHeader);
    
    // Get the nested nav container
    const nestedNav = categoryHeader.querySelector('.sidebar-nested-nav');
    
    // Add items for this category
    category.items.forEach(item => {
      const hasSubitems = item.subitems && item.subitems.length > 0;
      
      const itemElement = document.createElement('li');
      itemElement.className = hasSubitems ? 'sidebar-nested-item expanded' : 'sidebar-nested-item'; // Expanded by default if has subitems
      
      if (hasSubitems) {
        itemElement.innerHTML = `
          <a href="${item.url}" class="sidebar-nested-link">
            <span>${item.name}</span>
            <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" 
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <ul class="sidebar-deep-nav"></ul>
        `;
        
        // Get the deep nav container
        const deepNav = itemElement.querySelector('.sidebar-deep-nav');
        
        // Add subitems
        item.subitems.forEach(subitem => {
          const hasDeepSubitems = subitem.subitems && subitem.subitems.length > 0;
          
          const subitemElement = document.createElement('li');
          subitemElement.className = hasDeepSubitems ? 'sidebar-deep-item expanded' : 'sidebar-deep-item'; // Expanded by default if has deep subitems
          
          if (hasDeepSubitems) {
            subitemElement.innerHTML = `
              <a href="${subitem.url}" class="sidebar-deep-link">
                <span>${subitem.name}</span>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 24 24" fill="none" 
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </a>
              <ul class="sidebar-extra-nav"></ul>
            `;
            
            // Get the extra nav container
            const extraNav = subitemElement.querySelector('.sidebar-extra-nav');
            
            // Add deep subitems
            subitem.subitems.forEach(extraItem => {
              const extraItemElement = document.createElement('li');
              extraItemElement.className = 'sidebar-extra-item';
              extraItemElement.innerHTML = `
                <a href="${extraItem.url}" class="sidebar-extra-link">
                  <span>${extraItem.name}</span>
                </a>
              `;
              extraNav.appendChild(extraItemElement);
            });
          } else {
            subitemElement.innerHTML = `
              <a href="${subitem.url}" class="sidebar-deep-link">
                <span>${subitem.name}</span>
              </a>
            `;
          }
          
          deepNav.appendChild(subitemElement);
        });
      } else {
        itemElement.innerHTML = `
          <a href="${item.url}" class="sidebar-nested-link">
            <span>${item.name}</span>
          </a>
        `;
      }
      
      nestedNav.appendChild(itemElement);
    });
  });

  // Add click handlers for menu toggling
  addMenuToggleHandlers();
  
  // Highlight active menu items based on URL
  highlightActivePath();
}

// Add CSS styles
function addDsaBasicsStyles() {
  // Check if styles already exist
  if (document.getElementById('dsa-basics-styles')) {
    return;
  }
  
  const styleElement = document.createElement('style');
  styleElement.id = 'dsa-basics-styles';
  styleElement.textContent = `
    /* Scrollable sidebar fix */
    .scrollable-sidebar {
      max-height: 85vh !important;
      overflow-y: auto !important;
      scrollbar-width: thin;
      padding-right: 5px;
    }

    /* DSA Basics Menu Styles */
    /* Make the main sidebar container scrollable */
    .sidebar {
      max-height: 85vh;
      overflow-y: auto;
      padding-right: 5px;
    }

    /* Custom scrollbar styles */
    .sidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }
    
    .sidebar::-webkit-scrollbar-track {
      background-color: transparent;
    }
    
    .sidebar-nested-nav, .sidebar-deep-nav, .sidebar-extra-nav {
      list-style: none;
      padding-left: 15px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .sidebar-subnav-item.expanded > .sidebar-nested-nav,
    .sidebar-nested-item.expanded > .sidebar-deep-nav,
    .sidebar-deep-item.expanded > .sidebar-extra-nav {
      max-height: none !important; /* Allow unlimited height */
    }
    
    .category-header {
      font-weight: 600;
      color: var(--text-color);
      opacity: 0.8;
    }
    
    .sidebar-nested-link, .sidebar-deep-link, .sidebar-extra-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 12px;
      border-radius: 4px;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .sidebar-nested-link:hover, .sidebar-deep-link:hover, .sidebar-extra-link:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--text-color);
    }
    
    .sidebar-nested-link.active, .sidebar-deep-link.active, .sidebar-extra-link.active {
      background-color: rgba(249, 115, 22, 0.1);
      color: var(--primary-color, #f97316);
      font-weight: 500;
    }
    
    .sidebar-deep-link {
      font-size: 12px;
    }
    
    .sidebar-extra-link {
      font-size: 12px;
    }
    
    .toggle-icon {
      transition: transform 0.3s;
    }
    
    .sidebar-subnav-item.expanded > .sidebar-subnav-link .toggle-icon,
    .sidebar-nested-item.expanded > .sidebar-nested-link .toggle-icon,
    .sidebar-deep-item.expanded > .sidebar-deep-link .toggle-icon {
      transform: rotate(90deg);
    }
  `;
  document.head.appendChild(styleElement);
}

// Add click handlers for expandable menu items
function addMenuToggleHandlers() {
  // Category headers
  document.querySelectorAll('.sidebar-subnav-link.category-header').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const parent = this.parentElement;
      parent.classList.toggle('expanded');
    });
  });
  
  // Items with subitems
  document.querySelectorAll('.sidebar-nested-link .toggle-icon').forEach(icon => {
    icon.parentElement.addEventListener('click', function(e) {
      if (e.target === icon || e.target.closest('.toggle-icon') === icon) {
        e.preventDefault();
        const parent = this.parentElement;
        parent.classList.toggle('expanded');
      }
    });
  });
  
  // Deep items with extra subitems
  document.querySelectorAll('.sidebar-deep-link .toggle-icon').forEach(icon => {
    icon.parentElement.addEventListener('click', function(e) {
      if (e.target === icon || e.target.closest('.toggle-icon') === icon) {
        e.preventDefault();
        const parent = this.parentElement;
        parent.classList.toggle('expanded');
      }
    });
  });
}

// Highlight the active path and expand parent items
function highlightActivePath() {
  const currentUrl = window.location.href;
  
  // Clear any existing highlights
  document.querySelectorAll('.sidebar-nested-link.active, .sidebar-deep-link.active, .sidebar-extra-link.active')
    .forEach(link => link.classList.remove('active'));
  
  // Find all links
  const allLinks = [
    ...document.querySelectorAll('.sidebar-nested-link'),
    ...document.querySelectorAll('.sidebar-deep-link'),
    ...document.querySelectorAll('.sidebar-extra-link')
  ];
  
  // Find an exact match for the current URL
  let activeLink = null;
  for (const link of allLinks) {
    const href = link.getAttribute('href');
    if (href === currentUrl) {
      activeLink = link;
      break;
    }
  }
  
  // If we found a match, highlight it and expand parents
  if (activeLink) {
    activeLink.classList.add('active');
    
    // Expand all parent containers
    let parent = activeLink.parentElement;
    while (parent) {
      if (parent.classList.contains('sidebar-nested-item') || 
          parent.classList.contains('sidebar-deep-item') ||
          parent.classList.contains('sidebar-subnav-item')) {
        parent.classList.add('expanded');
      }
      parent = parent.parentElement;
    }
  }
}

// Expose global function to highlight a specific menu item
window.highlightDsaMenuItem = function(itemUrl) {
  // Clear any existing highlights
  document.querySelectorAll('.sidebar-nested-link.active, .sidebar-deep-link.active, .sidebar-extra-link.active')
    .forEach(link => link.classList.remove('active'));
  
  // Find the specified link
  const allLinks = [
    ...document.querySelectorAll('.sidebar-nested-link'),
    ...document.querySelectorAll('.sidebar-deep-link'),
    ...document.querySelectorAll('.sidebar-extra-link')
  ];
  
  let found = false;
  for (const link of allLinks) {
    const href = link.getAttribute('href');
    if (href === itemUrl) {
      // Add active class
      link.classList.add('active');
      
      // Expand parent items
      let parent = link.parentElement;
      while (parent) {
        if (parent.classList.contains('sidebar-nested-item') || 
            parent.classList.contains('sidebar-deep-item') ||
            parent.classList.contains('sidebar-subnav-item')) {
          parent.classList.add('expanded');
        }
        parent = parent.parentElement;
      }
      
      found = true;
      break;
    }
  }
  
  return found;
};

// Fix the original populateSidebar function to handle DSA Basics pages
(function() {
  // Store the original function
  const originalPopulateSidebar = window.populateSidebar;
  
  // Replace with our version
  window.populateSidebar = function(problems) {
    // Check if we're on a DSA Basics page
    if (isDsaBasicsPage()) {
      // If on a DSA Basics page, use our custom sidebar
      createDsaBasicsSidebar();
    } else {
      // Otherwise, call the original function for other pages
      if (typeof originalPopulateSidebar === 'function') {
        originalPopulateSidebar(problems);
      }
    }
  };
})();

// Fix the controlMenuVisibilityByURL function
(function() {
  // Store the original function
  const originalControlMenuVisibilityByURL = window.controlMenuVisibilityByURL;
  
  // Replace with our version
  window.controlMenuVisibilityByURL = function() {
    // Check if we're on a DSA Basics page
    if (isDsaBasicsPage()) {
      // If on a DSA Basics page, use our custom sidebar
      createDsaBasicsSidebar();
    } else {
      // Otherwise, call the original function for other pages
      if (typeof originalControlMenuVisibilityByURL === 'function') {
        originalControlMenuVisibilityByURL();
      }
    }
  };
})();

// Function to ensure the sidebar is properly scrollable
function ensureSidebarScrollable() {
  const sidebar = document.querySelector('.sidebar');
  if (!sidebar) return;
  
  // Apply styles directly
  sidebar.style.maxHeight = '85vh';
  sidebar.style.overflowY = 'auto';
  sidebar.style.position = 'relative';
  
  // Check if we need to add the scrollable class
  if (!sidebar.classList.contains('scrollable-sidebar')) {
    sidebar.classList.add('scrollable-sidebar');
  }
  
  // Fix parent containers too if they exist
  const parents = [];
  let parentElement = sidebar.parentElement;
  
  while (parentElement) {
    parents.push(parentElement);
    parentElement = parentElement.parentElement;
    
    // Don't go too far up the DOM tree
    if (parents.length > 5) break;
  }
  
  // Apply fixes to immediate parent elements
  parents.slice(0, 3).forEach(parent => {
    parent.style.height = 'auto';
    parent.style.maxHeight = 'none';
    parent.style.overflow = 'visible';
  });
  
  // Force browser reflow to apply the changes
  sidebar.offsetHeight;
  
  console.log("Applied scrollability fixes to sidebar");
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if we're on a DSA Basics page and create our sidebar if needed
  if (isDsaBasicsPage()) {
    createDsaBasicsSidebar();
    // Wait a short time for rendering
    setTimeout(ensureSidebarScrollable, 100);
  }
});

// Re-check on window load (in case images or other resources were still loading)
window.addEventListener('load', function() {
  // Check again after full page load
  if (isDsaBasicsPage()) {
    createDsaBasicsSidebar();
    highlightActivePath();
    ensureSidebarScrollable();
    
    // Try again after a longer delay to catch any layout shifts
    setTimeout(ensureSidebarScrollable, 500);
  }
});

// Also check when window hash changes (for single-page applications)
window.addEventListener('hashchange', function() {
  if (isDsaBasicsPage()) {
    highlightActivePath();
    ensureSidebarScrollable();
  }
});

// Expose scrollability function globally
window.ensureSidebarScrollable = ensureSidebarScrollable;
