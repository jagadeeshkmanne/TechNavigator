// DSA Basics Menu Data Structure - Structured according to requirements
const dsaBasicsData = {
  "dataStructures": {
    "title": "Data Structures",
    "items": [
      {
        "name": "Arrays",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/arrays/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/arrays/basic-operations"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/arrays/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/arrays/practice"}
        ]
      },
      {
        "name": "Linked Lists",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/linked-lists/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/linked-lists/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/linked-lists/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/linked-lists/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/linked-lists/practice"}
        ]
      },
      {
        "name": "Hash Tables",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/hash-tables/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/hash-tables/basic-operations"},
          {"name": "Collision Handling", "url": "https://www.technavigator.io/dsa-basics/hash-tables/collision-handling"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/hash-tables/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/hash-tables/practice"}
        ]
      },
      {
        "name": "Stacks",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/stacks/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/stacks/basic-operations"},
          {"name": "Applications", "url": "https://www.technavigator.io/dsa-basics/stacks/applications"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/stacks/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/stacks/practice"}
        ]
      },
      {
        "name": "Queues",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/queues/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/queues/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/queues/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/queues/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/queues/practice"}
        ]
      },
      {
        "name": "Trees",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/trees/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/trees/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/trees/types"},
          {
            "name": "Traversal",
            "subitems": [
              {"name": "Inorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/inorder"},
              {"name": "Preorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/preorder"},
              {"name": "Postorder Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/postorder"},
              {"name": "Level Order Traversal", "url": "https://www.technavigator.io/dsa-basics/trees/traversal/level-order"}
            ]
          },
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/trees/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/trees/practice"}
        ]
      },
      {
        "name": "Heaps",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/heaps/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/heaps/basic-operations"},
          {"name": "Types", "url": "https://www.technavigator.io/dsa-basics/heaps/types"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/heaps/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/heaps/practice"}
        ]
      },
      {
        "name": "Tries",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/tries/introduction"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/tries/basic-operations"},
          {"name": "Applications", "url": "https://www.technavigator.io/dsa-basics/tries/applications"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/tries/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/tries/practice"}
        ]
      },
      {
        "name": "Graphs",
        "subitems": [
          {"name": "Introduction", "url": "https://www.technavigator.io/dsa-basics/graphs/introduction"},
          {"name": "Representations", "url": "https://www.technavigator.io/dsa-basics/graphs/representations"},
          {"name": "Basic Operations", "url": "https://www.technavigator.io/dsa-basics/graphs/basic-operations"},
          {"name": "Videos", "url": "https://www.technavigator.io/dsa-basics/graphs/videos"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/graphs/practice"}
        ]
      }
    ]
  },
  "algorithms": {
    "title": "Algorithms",
    "items": [
      {
        "name": "Searching Algorithms",
        "subitems": [
          {"name": "Linear Search", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/linear-search"},
          {"name": "Binary Search", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/binary-search"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/searching-algorithms/practice"}
        ]
      },
      {
        "name": "Sorting Algorithms",
        "subitems": [
          {"name": "Bubble Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/bubble-sort"},
          {"name": "Selection Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/selection-sort"},
          {"name": "Insertion Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/insertion-sort"},
          {"name": "Merge Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/merge-sort"},
          {"name": "Quick Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/quick-sort"},
          {"name": "Heap Sort", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/heap-sort"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/sorting-algorithms/practice"}
        ]
      },
      {
        "name": "Graph Algorithms",
        "subitems": [
          {"name": "Depth-First Search (DFS)", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/dfs"},
          {"name": "Breadth-First Search (BFS)", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/bfs"},
          {
            "name": "Shortest Path Algorithms",
            "subitems": [
              {"name": "Dijkstra's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/dijkstra"},
              {"name": "Bellman-Ford Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/bellman-ford"},
              {"name": "Floyd-Warshall Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/shortest-path/floyd-warshall"}
            ]
          },
          {
            "name": "Minimum Spanning Tree",
            "subitems": [
              {"name": "Kruskal's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/minimum-spanning-tree/kruskal"},
              {"name": "Prim's Algorithm", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/minimum-spanning-tree/prim"}
            ]
          },
          {"name": "Topological Sort", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/topological-sort"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/graph-algorithms/practice"}
        ]
      },
      {
        "name": "Algorithm Techniques",
        "subitems": [
          {"name": "Two Pointers", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/two-pointers"},
          {"name": "Sliding Window", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/sliding-window"},
          {"name": "Prefix Sum", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/prefix-sum"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/algorithm-techniques/practice"}
        ]
      },
      {
        "name": "Advanced Algorithms",
        "subitems": [
          {"name": "Divide and Conquer", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/divide-and-conquer"},
          {"name": "Greedy Algorithms", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/greedy"},
          {"name": "Backtracking", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/backtracking"},
          {
            "name": "Dynamic Programming",
            "subitems": [
              {"name": "1D Dynamic Programming", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/1d"},
              {"name": "2D Dynamic Programming", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/2d"},
              {"name": "State Compression", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/dynamic-programming/state-compression"}
            ]
          },
          {"name": "Union Find", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/union-find"},
          {"name": "Monotonic Stack/Queue", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/monotonic-stack-queue"},
          {"name": "Practice", "url": "https://www.technavigator.io/dsa-basics/advanced-algorithms/practice"}
        ]
      }
    ]
  }
};

// Function to check if current page is a DSA Basics page
function isDsaBasicsPage() {
  const currentURL = window.location.href.toLowerCase();
  return currentURL.includes('datastructure-basics') || 
         currentURL.includes('data-structure-basics') ||
         currentURL.includes('algorithm-basics') || 
         currentURL.includes('algorithms-basics');
}

// Function to determine if a URL is related to data structures
function isDataStructuresURL(url) {
  url = url.toLowerCase();
  return url.includes('datastructure-basics') || url.includes('data-structure-basics');
}

// Function to determine if a URL is related to algorithms
function isAlgorithmsURL(url) {
  url = url.toLowerCase();
  return url.includes('algorithm-basics') || url.includes('algorithms-basics');
}

// Create sidebar with tabs and submenus
function createSimplifiedSidebar() {
  // Only run on DSA Basics pages
  if (!isDsaBasicsPage()) {
    return;
  }

  // Get the sidebar
  let sidebar = document.querySelector('.sidebar-nav');
  if (!sidebar) {
    console.error("Sidebar not found, creating new one");
    sidebar = document.createElement('ul');
    sidebar.className = 'sidebar-nav';
    const sidebarContainer = document.querySelector('.sidebar');
    if (sidebarContainer) {
      sidebarContainer.innerHTML = ''; // Clear the container
      sidebarContainer.appendChild(sidebar);
    } else {
      console.error("Sidebar container not found");
      return;
    }
  } else {
    // Clear existing sidebar
    sidebar.innerHTML = '';
  }

  // Create main menu item (without the title)
  const dsaBasicsItem = document.createElement('li');
  dsaBasicsItem.className = 'sidebar-nav-item expanded';
  dsaBasicsItem.innerHTML = `
    <div class="sidebar-tabs-container">
      <ul class="sidebar-tabs" id="dsa-basics-tabs"></ul>
      <div class="sidebar-tab-panels" id="dsa-tab-panels"></div>
    </div>
  `;
  sidebar.appendChild(dsaBasicsItem);

  // Add styles
  addTabStyles();

  // Get the tabs container
  const tabsContainer = document.getElementById('dsa-basics-tabs');
  const tabPanelsContainer = document.getElementById('dsa-tab-panels');

  // Current URL for matching links
  const currentURL = window.location.href.toLowerCase();
  
  // Determine which tab should be active by default
  const isDataStructures = isDataStructuresURL(currentURL);
  const isAlgorithms = isAlgorithmsURL(currentURL);
  const defaultActiveTab = isAlgorithms ? 'algorithms' : 'dataStructures';

  // Create tabs
  Object.keys(dsaBasicsData).forEach(categoryKey => {
    const category = dsaBasicsData[categoryKey];
    
    // Create the tab
    const tab = document.createElement('li');
    tab.className = 'sidebar-tab'; // Will add active class later if needed
    tab.innerHTML = `
      <a href="javascript:void(0)" class="sidebar-tab-link" data-tab="${categoryKey}">
        ${category.title}
      </a>
    `;
    tabsContainer.appendChild(tab);
    
    // Create the tab panel
    const tabPanel = document.createElement('div');
    tabPanel.className = 'sidebar-tab-panel';
    tabPanel.id = `${categoryKey}-panel`;
    
    // Add items to the panel
    let panelContent = '';
    category.items.forEach(item => {
      const hasSubitems = item.subitems && item.subitems.length > 0;
      
      if (hasSubitems) {
        panelContent += `
          <div class="sidebar-menu-item" data-name="${item.name.toLowerCase()}">
            <div class="sidebar-menu-header">
              <span class="sidebar-menu-title">${item.name}</span>
              <span class="toggle-icon">▼</span>
            </div>
            <ul class="sidebar-submenu">
        `;
        
        // Add first level subitems
        item.subitems.forEach(subitem => {
          const hasDeepSubitems = subitem.subitems && subitem.subitems.length > 0;
          
          if (hasDeepSubitems) {
            panelContent += `
              <li class="sidebar-submenu-item" data-name="${subitem.name.toLowerCase()}">
                <div class="sidebar-submenu-header">
                  <span class="sidebar-submenu-title">${subitem.name}</span>
                  <span class="toggle-icon">▼</span>
                </div>
                <ul class="sidebar-deep-submenu">
            `;
            
            // Add second level subitems
            subitem.subitems.forEach(deepSubitem => {
              panelContent += `
                <li class="sidebar-deep-submenu-item">
                  <a href="${deepSubitem.url}" class="sidebar-deep-submenu-link" data-name="${deepSubitem.name.toLowerCase()}">${deepSubitem.name}</a>
                </li>
              `;
            });
            
            panelContent += `
                </ul>
              </li>
            `;
          } else {
            panelContent += `
              <li class="sidebar-submenu-item">
                <a href="${subitem.url}" class="sidebar-submenu-link" data-name="${subitem.name.toLowerCase()}">${subitem.name}</a>
              </li>
            `;
          }
        });
        
        panelContent += `
            </ul>
          </div>
        `;
      } else {
        panelContent += `
          <div class="sidebar-menu-item" data-name="${item.name.toLowerCase()}">
            <span class="sidebar-menu-title">${item.name}</span>
          </div>
        `;
      }
    });
    
    tabPanel.innerHTML = panelContent;
    tabPanelsContainer.appendChild(tabPanel);
  });

  // Add tab click handlers
  addTabHandlers();
  
  // Add submenu toggle handlers with single item expansion
  addSingleExpandSubmenuHandlers();
  
  // Find and highlight the active item based on current URL
  highlightActiveItem(currentURL, defaultActiveTab);
}

// Add styles for the tabs and submenus
function addTabStyles() {
  // Same style code as before
  // ...
}

// Add tab click handlers
function addTabHandlers() {
  document.querySelectorAll('.sidebar-tab-link').forEach(tabLink => {
    tabLink.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get the tab ID
      const tabId = this.getAttribute('data-tab');
      
      // Remove active class from all tabs and panels
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.sidebar-tab-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // Add active class to clicked tab
      this.parentElement.classList.add('active');
      
      // Show the corresponding panel
      document.getElementById(`${tabId}-panel`).classList.add('active');
    });
  });
}

// Add submenu toggle handlers with single expansion
function addSingleExpandSubmenuHandlers() {
  // First level menus
  document.querySelectorAll('.sidebar-menu-header').forEach(header => {
    header.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get all menu items at this level
      const allMenuItems = document.querySelectorAll('.sidebar-menu-item');
      const menuItem = this.closest('.sidebar-menu-item');
      
      // If this item is already expanded, just collapse it
      if (menuItem.classList.contains('expanded')) {
        menuItem.classList.remove('expanded');
        return;
      }
      
      // Collapse all other items at this level
      allMenuItems.forEach(item => {
        item.classList.remove('expanded');
      });
      
      // Expand only this item
      menuItem.classList.add('expanded');
    });
  });
  
  // Second level menus
  document.querySelectorAll('.sidebar-submenu-header').forEach(header => {
    header.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Get all submenu items within the same parent menu
      const parentMenu = this.closest('.sidebar-submenu');
      const allSubmenuItems = parentMenu.querySelectorAll('.sidebar-submenu-item');
      const submenuItem = this.closest('.sidebar-submenu-item');
      
      // If this item is already expanded, just collapse it
      if (submenuItem.classList.contains('expanded')) {
        submenuItem.classList.remove('expanded');
        return;
      }
      
      // Collapse all other items at this level
      allSubmenuItems.forEach(item => {
        item.classList.remove('expanded');
      });
      
      // Expand only this item
      submenuItem.classList.add('expanded');
    });
  });
}

// Highlight the active item based on current URL
function highlightActiveItem(currentURL, defaultActiveTab) {
  let activeLink = null;
  let activeTabId = defaultActiveTab;
  
  // Find all links in the sidebar
  const allLinks = [
    ...document.querySelectorAll('.sidebar-submenu-link'),
    ...document.querySelectorAll('.sidebar-deep-submenu-link')
  ];
  
  // Try to find an exact match for the current URL
  for (const link of allLinks) {
    const href = link.getAttribute('href').toLowerCase();
    if (currentURL.includes(href)) {
      activeLink = link;
      break;
    }
  }
  
  // If we found a matching link
  if (activeLink) {
    // Add active class to the link
    activeLink.classList.add('active');
    
    // Expand parent menu items
    let parent = activeLink.parentElement;
    while (parent) {
      // For submenu item
      if (parent.classList.contains('sidebar-submenu-item')) {
        parent.classList.add('expanded');
      }
      
      // For menu item
      if (parent.classList.contains('sidebar-menu-item')) {
        parent.classList.add('expanded');
        
        // Determine which tab this belongs to
        const panel = parent.closest('.sidebar-tab-panel');
        if (panel) {
          activeTabId = panel.id.replace('-panel', '');
        }
      }
      
      parent = parent.parentElement;
    }
  }
  
  // Activate the correct tab
  const activeTab = document.querySelector(`.sidebar-tab-link[data-tab="${activeTabId}"]`);
  if (activeTab) {
    // Remove active class from all tabs and panels
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.sidebar-tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    
    // Add active class to the tab
    activeTab.parentElement.classList.add('active');
    
    // Show the corresponding panel
    document.getElementById(`${activeTabId}-panel`).classList.add('active');
  }
}

// Fix the original populateSidebar function
(function() {
  // Store the original function
  const originalPopulateSidebar = window.populateSidebar;
  
  // Replace with our version
  window.populateSidebar = function(problems) {
    // Check if we're on a DSA Basics page
    if (isDsaBasicsPage()) {
      // If on a DSA Basics page, use our sidebar
      createSimplifiedSidebar();
    } else {
      // Otherwise, call the original function
      if (typeof originalPopulateSidebar === 'function') {
        originalPopulateSidebar(problems);
      }
    }
  };
})();

// Fix the controlMenuVisibilityByURL function
(function() {
  // Store the original function
  const originalControlMenuVisibilityByURL = window.controlMenuVisibilityByURL;
  
  // Replace with our version
  window.controlMenuVisibilityByURL = function() {
    // Check if we're on a DSA Basics page
    if (isDsaBasicsPage()) {
      // If on a DSA Basics page, use our sidebar
      createSimplifiedSidebar();
    } else {
      // Otherwise, call the original function
      if (typeof originalControlMenuVisibilityByURL === 'function') {
        originalControlMenuVisibilityByURL();
      }
    }
  };
})();

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if we're on a DSA Basics page
  if (isDsaBasicsPage()) {
    createSimplifiedSidebar();
  }
});

// Re-check on window load
window.addEventListener('load', function() {
  // Check again after full page load
  if (isDsaBasicsPage()) {
    createSimplifiedSidebar();
  }
});
